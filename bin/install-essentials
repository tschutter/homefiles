#!/bin/sh
#
# Install essential packages.
#

ROOTDIR="${HOME}/.homefiles"
HAS_PIP=true
if [ -x "/usr/bin/doas" ]; then
    SUDO="/usr/bin/doas"
else
    SUDO="sudo"
fi

if [ -x "/usr/bin/apt-get" ]; then
    # Debian derivatives.
    # http://packages.ubuntu.com/
    # sudo apt-cache search REGEX
    # ncurses-term adds /etc/terminfo for urxvt
    PACKAGES="\
        emacs24\
        emacs24-el\
        git\
        git-doc\
        git-man\
        libdata-ical-perl\
        libnotify-bin\
        libtext-autoformat-perl\
        mg\
        mutt\
        muttprint\
        ncurses-term\
        psutils\
        pychecker\
        pyflakes\
        pylint\
        pymacs\
        python-docutils\
        python-pip\
        python-rope\
        python2.7-dev\
        python2.7-doc\
        tmux\
        w3m-el\
        w3m\
        xsel\
        xzgv\
    "

    ${SUDO} apt-get install ${PACKAGES}

    # Set the executable from xfce4-terminal as the default xterm.
    # rxvt-unicode suffers from the Ctrl-Shift gives yellow box problem.
    ${SUDO} update-alternatives --set x-terminal-emulator /usr/bin/xfce4-terminal.wrapper

elif [ -x "/usr/sbin/pkg_add" ]; then
    # OpenBSD.
    # pkg_add supports `stems with flavors', that is, a stem separated
    # from flavors with a double dash.  "screen--" matches only the
    # normal flavor, "screen--static" matches only the static flavor.
    # http://mirror.esc7.net/pub/OpenBSD/<VERSION>/packages/amd64/
    PACKAGES="\
        git\
        mutt--\
        python-3*\
        emacs--gtk3\
        pep8\
        psutils--\
        py-pip\
        pylint\
        pyflakes\
        rxvt-unicode\
        ucpp\
        w3m--\
        wget\
        xsel\
    "
        #emacs-python\

    doas pkg_add -i -z ${PACKAGES}

elif [ -x "/usr/bin/zypper" ]; then
    # OpenSUSE.
    # https://software.opensuse.org/search
    # zypper search
    PACKAGES="\
        emacs-24.3\
        git\
        lynx\
        mutt\
        rxvt-unicode\
        tmux\
        w3m\
        xsel\
        xzgv\
    "

    ${SUDO} zypper install --auto-agree-with-licenses --no-recommends ${PACKAGES}

    HAS_PIP=false

elif [ -x "/usr/bin/yum" ]; then
    # Red Hat, CentOS.
    # http://mirror.centos.org/centos/6/os/x86_64/Packages/
    # sudo yum list
    PACKAGES="\
        emacs-23*\
        git\
        lynx\
        mutt\
        rxvt-unicode\
        tmux\
        w3m\
        xsel\
        xzgv\
    "

    ${SUDO} yum install ${PACKAGES}

    HAS_PIP=false

else
    echo "ERROR: Unknown package manager."
    exit 1
fi

if [ "${HAS_PIP}" = "true" ]; then
    # Python packages via pip.
    PYPI_PACKAGES="\
        setuptools\
        goobook\
        line_profiler\
        pyprof2calltree\
    "

    echo "INFO: Installing Python packages..."
    ${SUDO} pip install --upgrade ${PYPI_PACKAGES}
fi

# As of 2012-01-11, the python-ropemacs 0.6c2-4 package is broken.  It
# ignores the ropemacs-enable-shortcuts variable when loading.
# Therefore we load it the hard way.
cd /tmp

tar xzf ${ROOTDIR}/packages/agr-ropemode-584d3eba7ca6.tar.gz
cd agr-ropemode-584d3eba7ca6
${SUDO} /usr/bin/env python setup.py --quiet install
cd ..
${SUDO} rm -rf agr-ropemode-584d3eba7ca6

tar xzf ${ROOTDIR}/packages/agr-ropemacs-7af544334b85.tar.gz
cd agr-ropemacs-7af544334b85
${SUDO} /usr/bin/env python setup.py --quiet install
cd ..
${SUDO} rm -rf agr-ropemacs-7af544334b85
