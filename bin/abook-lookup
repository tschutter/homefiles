#!/usr/bin/env python3

"""
Lookup an entry in an abook(1) addressbook file.
"""

import argparse
import itertools
import os
import re
import sys


def is_record_id(line):
    """Return True if line is a record id line."""
    return len(line) > 2 and line[0] == "[" and line[1] in "0123456789"


def record_matches(record, patterns):
    """Return True if record matches any pattern."""
    for pattern in patterns:
        for line in record:
            if pattern.search(line):
                return True
    return False


def main():
    """main"""
    arg_parser = argparse.ArgumentParser(
        description="Lookup an entry in an abook(1) addressbook file."
    )
    arg_parser.add_argument(
        "--datafile",
        default="$HOME/.abook/addressbook",
        help="addressbook file (default=%(default)s)"
    )
    arg_parser.add_argument(
        "pattern",
        nargs="+",
        help="regular expression pattern"
    )

    # Parse command line.
    args = arg_parser.parse_args()
    args.datafile = os.path.expandvars(args.datafile)

    # Compile args to regular expressions.
    patterns = [re.compile(arg, re.IGNORECASE) for arg in args.pattern]

    # Process datafile.
    first = True
    with open(args.datafile) as datafile:
        for key, record in itertools.groupby(datafile, key=is_record_id):
            if not key:
                record = list(
                    line.rstrip()
                    for line in record
                    if len(line) > 1
                )
                if record_matches(record, patterns):
                    if first:
                        first = False
                    else:
                        print()
                    for line in record:
                        print(line)

    return 0


if __name__ == "__main__":
    sys.exit(main())
