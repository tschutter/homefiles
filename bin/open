#!/bin/sh
#
# Open a file or URL in the user's preferred application.
#

# Determine platform.
_UNAME=$(uname)
if [ "${_UNAME%%-*}" = "CYGWIN_NT" ]; then
    OPEN=cygstart
else
    OPEN=xdg-open
fi

if [ $# -lt 1 ]; then
    echo "ERROR: No file specified."
    exit 1
fi

# Render help.
if [ "$1" = "--help" ]; then
    echo "Usage: $0 [options] file [file...]"
    echo "  Opens files with their preferred application."
    echo ""
    echo "Options:"
    echo "  --help         show this help message and exit"
    echo "  --query        print which application would be used to open file"
    exit 0
fi

# Check for --query option.
QUERY=
if [ "$1" = "--query" ]; then
    QUERY=1
    shift
fi

# Transform requested file.
FILE="$1"
TMPFILE=
case "${FILE}" in
    *\.rst|*\.txt)
        # reStructuredText files to .html.
        TMPFILE=`mktemp --suffix=.html`
        rst2html "${FILE}" ${TMPFILE}
        FILE=${TMPFILE}
        ;;
esac

# Handle --query option.
if [ "${QUERY}" ]; then
    if [ "${OPEN}" = "cygstart" ]; then
        ${OPEN} --find "${FILE}"
    else
        if [ ! -f "${FILE}" ]; then
            echo "ERROR: File \"${FILE}\" not found"
            exit 1
        fi
        MIME_TYPE=`xdg-mime query filetype "${FILE}"`
        DEFAULT=`xdg-mime query default "${MIME_TYPE}"`
        echo "${FILE} -> ${MIME_TYPE} -> ${DEFAULT}"
    fi

    # Cleanup temporary file.
    if [ "${TMPFILE}" ]; then
        rm -f "${FILE}"
    fi
else
    # Open the specified argument.
    ${OPEN} "${FILE}"
    # Deleting temporary file doesn't work because OPEN returns immediately.
fi
